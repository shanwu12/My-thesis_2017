
\chapter{小型化组合定位系统硬件设计}
\section{引言}
根据前一章系统总体方案的设计，本章的重点工作是完成系统的硬件平台。车载组合定位系统硬件设计分为：器件选型、嵌入式ARM系统设计、外围设备设计、数据传感器设计，硬件测试。硬件设计需要考虑以下几个问题：抗干扰问题，GPS信号在复杂的场合，容易受到各种干扰，必须保证信号的稳定性并考虑省电节能问题。硬件设计过程如下图所示：

本设计硬件是在Altium Designer 10 上进行设计的。这是一款由Altium 公司开发的基于Windows环境下的电路板设计软件，在电子行业运用十分普遍，是电子工程师设计印刷线路板的首选工具，它具有简单易学，操作便捷，资源丰富，人机交互良好等优点。

\section{主要器件选型}
本课题是利用MIMU构建捷联惯性导航系统，然后接收卫星信号对导航结果进行补偿和融合，得到可信度高的姿态、速度和位置等信息。最终可以应用在地面车辆上，需要良好的稳定性和抗干扰能力。所以，再设计时，不仅需要对其进行规划分析，还要根据工作环境和运行条件进行芯片的选型。以下将介绍几个主要器件的选型。
\subsection{ARM芯片}
明确硬件总体需求情况选择的CPU的处理能力、存储容量及速度、IO端口的分配、接口要求、电平要求等等。综合这些因素考虑本系统采用的处理芯片为ST公司的STM32F405VGT6型号的ARM芯片，其属于STM32F4系列，是基于Cortex-M4内核的，是一款升级版的处理器，具有多方面的优势：
1）相比于Cortex M3芯片,STM32F4最大的优势就是内置单精度FPU和DSP指令，可提升控制算法的执行速度，提高代码执行效率，本设计中涉及导航数据的解算而且导航解算对实时性要求比较高，该优势可以很好地展现出来。

2）芯片主频达到168Mhz，片上flash可达1MB,SRAM有192KB，有着丰富的内存资源，满足本设计程序和数据的处理和存储要求。

3）在实现高性能和低功耗方面更灵活。本设计的目的是实现小型化低功耗的导航模块,而STM32F40x的功耗为：在主频168MHz情况下，在闪存中执行coreMark基准测试程序，功耗仅为230uA/MHz。在运行模式下，STM32F4具有更高的功耗效率，特别适合需要一定运算量的应用场合。

4)功能强大、价格低廉，性价比高。

STM32F405RGT6是F4系列的一款设备，我们选用LQNF100封装，内置有1M闪存。其通讯接口丰富，主要接口如下:
\begin{itemize}
\item 4个10.5Mbit/s的USART，加上两个UART；
\item 3个42Mbit/s的SPI；
\item 3个$I^2C$；
\item 2个CAN；
\item 1个SDIO），满足本设计的通讯接口的需求；
\item 1个全速USB OTG和一个高速USB OTG；
\end{itemize}

\subsection{MEMS器件}
本设计采用的MEMS器件是德国博世公司研发的六轴惯性传感器芯片BMI160，该模块集成了三轴陀螺仪、三轴加速度计和温度传感器。外形尺寸仅为$2.5mm\times3.0\times0.83mm$，实物图如？所示：
惯性器件能通过信号调节功能优化动态性能，且工厂校准为每一个传感器提供了灵敏度、偏置、带宽、零偏等参数，并为内部每个传感器提供补偿，可以提供高精度的传感器输出。

BMI160的性能指标如表？所示


\subsection{卫星接收模块}
卫星接收模块采用的是U-blox公司的NEO-M8N系列芯片。NEO-M8N是一款高性能,高灵敏度的卫星信号接收模块，虽然其外形尺寸只有$16\times12.2\times2.4mm$,却可以提供丰富的卫星数据信息，模块的高灵敏度、低功耗及轻巧的体积，非常适用于车载、手机、无人机及其他移动定位系统的应用。其实物如图？所示：

U-blox8拥有22个跟踪通道，66个捕获通道，热启动下捕获卫星信号的速度不足一秒，模块速度极快，其捕获和跟踪灵敏度甚至达到-160dBm。同时，这款芯片采用创新设计和技术，能有效抑制干扰源和多路径效应，在恶劣环境下也能提供有效的导航信息。
NEO-M8N的性能指标如表？所示：

NEO-M8N有多种接口方式：UART、SPI以及USB接口三种模式；数据输出格式有：NMEA、UBX和RTCM。本文将NEO-M8N与STM32芯片相连，采用最为方便利于开发的USART接口连接方式。据格格式采用工程中常用的NMEA-0183协议，该协议是美国国家海洋电子协会(national marine electronics association)为海用电子设备指定的一套标准格式，目前绝大部分卫星接收机都采用NMEA-0183协议输出位置、速度、星历等导航信息

\subsection{电源管理模块}
电源是一个系统中及其重要的一部分，电源的设计直接影响到系统能否正常工作。根据设计要求，模块通过USB供电或者引出电源管脚外部5V供电，为了使整个系统稳定的工作，选择稳压芯片输出稳定的电压。系统中需要的电压有5V 和3.3V。因此本系统对电源做了两级处理，前级电源输出5V的电压，接着连接3.3V的稳压芯片，保证了系统供电的稳定性。本系统选择德州仪器的TPS73133 具有反向电流保护的超低功耗电压稳压器件，系列线性稳压器是设计用于功耗敏感类应用的超低静态电流器件。一个精密带隙和误差放大器在温度范围内的精度为2。 只有1μA 的静态电流使这些器件成为要求极小闲置状态功率耗散的电池供电常开系统的理想解决方案。为了增加安全性，这些器件还具有热关断、电流限制和反向电流保护功能。通过将使能(EN)引脚下拉至低电平可将这些稳压器置于关断模式。这个模式的关断电流低至150nA（典型值）。
\section{硬件电路设计}
\subsection{系统原理图设计}
在设计原理图时，要清楚了解器件的使用和系统的开发，考虑系统的接地、环路、电源滤波等防止电磁干扰的措施。
ARM最小系统原理图如下所示：
\begin{figure}[!htb]
 \centering
 \includegraphics[width=0.9\textwidth]{figures/chap3/chap3_Arm}\\    % e.g.,[scale=0.75], [width=0.75\textwidth ]
 \caption{ARM最小系统原理图}
 \label{chap3_Fig.1}
 \vspace{-0.4cm}
\end{figure}

\begin{figure}[!htb]
 \centering
 \includegraphics[width=0.3\textwidth]{figures/chap3/chap3_RST}\\    % e.g.,[scale=0.75], [width=0.75\textwidth ]
 \caption{复位电路}
 \label{chap3_Fig.2}
 \vspace{-0.4cm}
\end{figure}

系统只要采用STM32F405RGT6处理器作为控制器，其中包括晶振时钟电路、复位电路、boot启动模式设置接口等从图中还可以看出，主控单元采用3.3V供电方式，数字地和模拟地采用电感隔离，避免信号的干扰。基准电压参考地、STM32 是低电平复位的，电阻R28和电容C25构成上电复位电路。当系统上电时，电源接通给电容充电，电容两端电压上升至3.3V，系统正常工作，当复位按键按下，开关导通电容两端形成回路开始放电，RST 电位被拉低，低电平复位。
ARM的BOOT0和BOOT1管脚用于设置STM32的启动方式，其对应启动模式如表？所示：
\begin{table}[!h]
\renewcommand\arraystretch{1.2}
\centering
\caption{\label{chap3_Table 1}启动模式设置接口}
\begin{tabular}{cccc}
\hline
$BOOT0$ & $BOOT1$ & 启动模式 & 说明 \\
\hline
$0$ & $X$ & 用户闪存存储器 & 用户闪存存储器，即从Flash启动 \\
$1$ & $0$ & 系统存储器 & 系统储存器启动，用于串口下载 \\
$1$ & $1$ & SRAM启动 & SRAM启动，可在SRAM中调试代码 \\
\hline
\end{tabular}
\end{table}

程序下载配置电路：STM32的程序下载有多种方法：USB、串口、JTAG、SWD。上面介绍了程序的启动模式，我们配置了BOOT0和BOOT1都接地，程序即从flash启动。由于板子尺寸较小，这里没有采用JTAG方式，因为其占用的IO管脚比较多，选择的SWD模式占用的IO很少，只需要两根信号线和电源线，而且下载速度也非常快，SWD不仅可以下载代码，还可以实时跟踪调试，寻找程序中的bug, 让开发事半功倍。

电源处理部分：这主要完成对系统的供电

电源稳定地输出是系统正常工作的前提，因此要选择输出电压稳定性高、纹波噪声小的稳压芯片，为使传感器能够稳定工作，设计过程中采用隔离的供电方式，电源设计采用了两个稳压芯片，一个单独供GPS传感器供电，通过程序控制芯片使能端管脚的电平，另外一路稳压为主控芯片和其他外设供电。电源电路如图？所示：
\begin{figure}[!htb]
 \centering
 \includegraphics[width=0.5\textwidth]{figures/chap3/chap3_Power}\\    % e.g.,[scale=0.75], [width=0.75\textwidth ]
 \caption{BMI160硬件电路设计}
 \label{chap3_Fig.2}
 \vspace{-0.4cm}
\end{figure}

MEMS传感器模块设计相应的原理图如下：
\begin{figure}[!htb]
 \centering
 \includegraphics[width=0.9\textwidth]{figures/chap3/chap3_Principle}\\    % e.g.,[scale=0.75], [width=0.75\textwidth ]
 \caption{BMI160硬件电路设计}
 \label{chap3_Fig.2}
 \vspace{-0.4cm}
\end{figure}
图中采用退耦电容C18、C21消除电源纹波对供电电路的影响。从电路图可以看出BMI160通过SPI高速串行接口来和ARM处理器进行数据通讯。BMI160 是一个自动测量系统，当系统上电后，器件自检通过后，就可以输出六轴传感器数据，默认采样频率为6.4KHz。程序设置100Hz取数，使控制器执行终端可实现100Hz带宽。一般带宽大时，动态响应虽提高，噪声（即稳态误差）也随之增加。 动态在大于200Hz时，大约有3dB的信号损失，噪声也会增加，表现出来的是惯性传感器零偏稳定性变差。
BMI160作为从设备，与主设备进行通讯采用SPI接口，SPI采用全双工模式，这样当设备发送目标地址给BMI160时，主设备能够读取其寄存器的内容，这一过程在同一个时钟信号SCLK中完成。数据采用选择普通模式，如图？所示。当用户通过查阅芯片手册，从寄存器地址可以读出目标测量数据。
寄存器对应表？如下：

内部寄存器都是十六位宽度，分高低八位两个字节，但只要一个字节的地址即可访问全部的两个字节。例如X轴加速度计输出寄存器XACCL\_OUT，地址为0x0A,寄存器内容为X轴加速度计的输出数据，并以14位二进制补码的形式存储。当需要读取X轴加速度计的输出数据时，只需要通过编程在给芯片写入0x0A的数据，SPI即可在输出端返回16位寄存器的数据，再通过二进制补码的格式将其转换成十进制，乘以相应的刻度即可得到X轴加速度计的数据。

SD卡主要完成实验过程中的数据保存功能，可以方便地进行调试和数据分析。

在设计卫星接受模块电路时，设计中为减小信号间的串扰采用了隔离供电的方式，模块引出电源引脚连接$3V3_2$，可以由处理器编程控制稳压电源芯片的输出使能来达到控制卫星芯片工作的目的。设计IPX天线接口可用于扩展GPS有源天线，非常适合地面车辆的使用。设备TIMEPULSE端口连接到状态指示灯，此端口的输出特性可以通过程序进行设置，在默认情况下，有两个状态，这样通过指示灯可以方便判断当前卫星定位的情况。选择STM32的USART3连接设置NEO-M8N模块，连线引脚图如上图所示
\begin{table}[!h]
\renewcommand\arraystretch{1.2}
\centering
\caption{\label{chap3_Table 1}启动模式设置接口}
\begin{tabular}{cccc}
\hline
状态 && 状态说明 \\
\hline
常亮 && 未实现定位\\
闪烁 && 模块定位成功\\
\hline
\end{tabular}
\end{table}

硬件板载一个MiniUSB头，用于USB从机(SLAVE)通信，可以让设备同电脑端USB通信进行数据的传输，同时，还可以为系统供电，但电流不超过500mA。

\subsection{系统PCB板设计}
使用Altium Designer完成原理图设计后，还要绘制PCB图来制作印刷电路板，PCB板是电路元件的载体，提供了元器件之间的电气连接。在设计PCB 时，必须遵守电路设计的一般规则，不仅要解决好信号的传输问题，还要消除电磁耦合的影响。在设计电路板时，根据以下几个规则：\\
1、器件布局

元器件布局尽量紧凑，各模块之间以主处理器为中心，其他器件以扇形状态置于元器件周围，总的连线尽可能短，关键信号线最短。使用同一电源的器件尽可能的放在一块，便于电源管理。\\
2、布线

地线布线遵循了环路最小原则，即信号线与其回路构成的环面积要尽可能小，环面积越小，对外的辐射越少，接收外界的干扰也越小；信号线之间会因较长的平行布线引起相互干扰，主要是由于平行线间的分布电容和分布电感的作用，扩大线间距、尽可能少走平行线，不走环行线以此来克服串扰。增加线宽度，重要信号间，平行地线的方法隔离。\\
3、接地

接地技术的目的是最小化接地阻抗，以减少从电路返回到电源之间的接地回路的电势。去耦电容放置在距离IC供电线和接地层之间尽可能近的地方。

显然，由于电路板面积，总体安装位置等的限制，按上述原则设计会受到一定的限制。因此，在设计时，需要对布局和布线分别考虑，达到最佳的状态。

\subsection{硬件调试}
电路板设计加工完成后，首先进行硬件电路测试，，调试没有问题后进行系统软件测试。下面说明一下硬件调试过程：
上电之前，先肉眼观察有无明显焊接错误，用万用表检查电源否有短路现象、地及一些关键信号线之间的连接情况。
上电后，触摸一下芯片是否有发热严重的现象，如果个别芯片发烫，一般是有问题，需要立即断电检查排除故障后重新上电。接下来检查是否可以长时间稳定工作。
\section{主要结果}

\section{本章小结}

本章主要研究了多个二阶非线性系统的分布式模型预测一致控制问题，智能体系统之间存在成本耦合，所有智能体共享一个参考轨迹。利用同步更新策略，在上一章的基础上，提出了新的相容性约束上界；利用参考轨迹，设计了每个智能体的终端成分，并给出了其需要满足的条件；给出了分布式优化算法；分析了优化问题的迭代可行性和整个系统的闭环收敛性；最后通过仿真实验验证了算法的有效性。









